!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CKEditor5=e():(t.CKEditor5=t.CKEditor5||{},t.CKEditor5.drupalImage=e())}(self,(function(){return function(){var t={"ckeditor5/src/core.js":function(t,e,i){t.exports=i("dll-reference CKEditor5.dll")("./src/core.js")},"ckeditor5/src/ui.js":function(t,e,i){t.exports=i("dll-reference CKEditor5.dll")("./src/ui.js")},"ckeditor5/src/upload.js":function(t,e,i){t.exports=i("dll-reference CKEditor5.dll")("./src/upload.js")},"ckeditor5/src/utils.js":function(t,e,i){t.exports=i("dll-reference CKEditor5.dll")("./src/utils.js")},"dll-reference CKEditor5.dll":function(t){"use strict";t.exports=CKEditor5.dll}},e={};function i(r){var s=e[r];if(void 0!==s)return s.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,i),n.exports}i.d=function(t,e){for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)};var r={};return function(){"use strict";i.d(r,{default:function(){return E}});var t=i("ckeditor5/src/core.js");function e(t,e,i){if(e.attributes)for(const[r,s]of Object.entries(e.attributes))t.setAttribute(r,s,i);e.styles&&t.setStyle(e.styles,i),e.classes&&t.addClass(e.classes,i)}function s(t){return t.createEmptyElement("img")}function n(t){const e=parseFloat(t);return!Number.isNaN(e)&&t===String(e)}const o=[{modelValue:"alignCenter",dataValue:"center"},{modelValue:"alignRight",dataValue:"right"},{modelValue:"alignLeft",dataValue:"left"}];class a extends t.Plugin{static get requires(){return["ImageUtils"]}static get pluginName(){return"DrupalImageEditing"}init(){const{editor:t}=this,{conversion:i}=t,{schema:r}=t.model;r.isRegistered("imageInline")&&r.extend("imageInline",{allowAttributes:["dataEntityUuid","dataEntityType","isDecorative","width","height"]}),r.isRegistered("imageBlock")&&r.extend("imageBlock",{allowAttributes:["dataEntityUuid","dataEntityType","isDecorative","width","height"]}),i.for("upcast").add(function(t){function e(e,i,r){const{viewItem:s}=i,{writer:n,consumable:a,safeInsert:l,updateConversionResult:u,schema:c}=r,d=[];let m;if(!a.test(s,{name:!0,attributes:"src"}))return;const g=a.test(s,{name:!0,attributes:"data-caption"});if(m=c.checkChild(i.modelCursor,"imageInline")&&!g?n.createElement("imageInline",{src:s.getAttribute("src")}):n.createElement("imageBlock",{src:s.getAttribute("src")}),t.plugins.has("ImageStyleEditing")&&a.test(s,{name:!0,attributes:"data-align"})){const t=s.getAttribute("data-align"),e=o.find((e=>e.dataValue===t));e&&(n.setAttribute("imageStyle",e.modelValue,m),d.push("data-align"))}if(g){const e=n.createElement("caption"),i=t.data.processor.toView(s.getAttribute("data-caption")),o=n.createDocumentFragment();r.consumable.constructor.createFrom(i,r.consumable),r.convertChildren(i,o);for(const t of Array.from(o.getChildren()))n.append(t,e);n.append(e,m),d.push("data-caption")}a.test(s,{name:!0,attributes:"data-entity-uuid"})&&(n.setAttribute("dataEntityUuid",s.getAttribute("data-entity-uuid"),m),d.push("data-entity-uuid")),a.test(s,{name:!0,attributes:"data-entity-type"})&&(n.setAttribute("dataEntityType",s.getAttribute("data-entity-type"),m),d.push("data-entity-type")),l(m,i.modelCursor)&&(a.consume(s,{name:!0,attributes:d}),u(m,i))}return t=>{t.on("element:img",e,{priority:"high"})}}(t)).attributeToAttribute({view:{name:"img",key:"width"},model:{key:"width",value:t=>n(t.getAttribute("width"))?`${t.getAttribute("width")}px`:`${t.getAttribute("width")}`}}).attributeToAttribute({view:{name:"img",key:"height"},model:{key:"height",value:t=>n(t.getAttribute("height"))?`${t.getAttribute("height")}px`:`${t.getAttribute("height")}`}}),i.for("downcast").add(function(){function t(t,e,i){const{item:r}=e,{consumable:s,writer:n}=i;if(!s.consume(r,t.name))return;const o=i.mapper.toViewElement(r),a=Array.from(o.getChildren()).find((t=>"img"===t.name));n.setAttribute("data-entity-uuid",e.attributeNewValue,a||o)}return e=>{e.on("attribute:dataEntityUuid",t)}}()).add(function(){function t(t,e,i){const{item:r}=e,{consumable:s,writer:n}=i;if(!s.consume(r,t.name))return;const o=i.mapper.toViewElement(r),a=Array.from(o.getChildren()).find((t=>"img"===t.name));n.setAttribute("data-entity-type",e.attributeNewValue,a||o)}return e=>{e.on("attribute:dataEntityType",t)}}()),i.for("dataDowncast").add(function(t){return e=>{e.on("insert:caption",((e,i,r)=>{const{consumable:s,writer:n,mapper:o}=r;if(!t.plugins.get("ImageUtils").isImage(i.item.parent)||!s.consume(i.item,"insert"))return;const a=t.model.createRangeIn(i.item),l=n.createDocumentFragment();o.bindElements(i.item,l);for(const{item:e}of Array.from(a)){const i={item:e,range:t.model.createRangeOn(e)},s=`insert:${e.name||"$text"}`;t.data.downcastDispatcher.fire(s,i,r);for(const s of e.getAttributeKeys())Object.assign(i,{attributeKey:s,attributeOldValue:null,attributeNewValue:i.item.getAttribute(s)}),t.data.downcastDispatcher.fire(`attribute:${s}`,i,r)}for(const t of n.createRangeIn(l).getItems())o.unbindViewElement(t);o.unbindViewElement(l);const u=t.data.processor.toData(l);if(u){const t=o.toViewElement(i.item.parent);n.setAttribute("data-caption",u,t)}}),{priority:"high"})}}(t)).elementToElement({model:"imageBlock",view:(t,{writer:e})=>s(e),converterPriority:"high"}).elementToElement({model:"imageInline",view:(t,{writer:e})=>s(e),converterPriority:"high"}).add(function(){function t(t,e,i){const{item:r}=e,{consumable:s,writer:n}=i,a=o.find((t=>t.modelValue===e.attributeNewValue));if(!a||!s.consume(r,t.name))return;const l=i.mapper.toViewElement(r),u=Array.from(l.getChildren()).find((t=>"img"===t.name));n.setAttribute("data-align",a.dataValue,u||l)}return e=>{e.on("attribute:imageStyle",t,{priority:"high"})}}()).add(function(){function t(t,e,i){const{item:r}=e,{consumable:s,writer:n}=i;if(!s.consume(r,t.name))return;const o=i.mapper.toViewElement(r),a=Array.from(o.getChildren()).find((t=>"img"===t.name));n.setAttribute("width",e.attributeNewValue.replace("px",""),a||o)}return e=>{e.on("attribute:width:imageInline",t,{priority:"high"}),e.on("attribute:width:imageBlock",t,{priority:"high"})}}()).add(function(){function t(t,e,i){const{item:r}=e,{consumable:s,writer:n}=i;if(!s.consume(r,t.name))return;const o=i.mapper.toViewElement(r),a=Array.from(o.getChildren()).find((t=>"img"===t.name));n.setAttribute("height",e.attributeNewValue.replace("px",""),a||o)}return e=>{e.on("attribute:height:imageInline",t,{priority:"high"}),e.on("attribute:height:imageBlock",t,{priority:"high"})}}()).add(function(){function t(t,i,r){if(!r.consumable.consume(i.item,t.name))return;const s=r.mapper.toViewElement(i.item),n=r.writer,o=n.createContainerElement("a",{href:i.attributeNewValue});n.insert(n.createPositionBefore(s),o),n.move(n.createRangeOn(s),n.createPositionAt(o,0)),r.consumable.consume(i.item,"attribute:htmlLinkAttributes:imageBlock")&&e(r.writer,i.item.getAttribute("htmlLinkAttributes"),o)}return e=>{e.on("attribute:linkHref:imageBlock",t,{priority:"high"})}}())}}class l extends t.Command{refresh(){const t=this.editor.plugins.get("ImageUtils").getClosestSelectedImageElement(this.editor.model.document.selection);this.isEnabled=!!t,this.isEnabled&&t.hasAttribute("alt")?this.value=t.getAttribute("alt"):this.value=!1}execute(t){const e=this.editor,i=e.plugins.get("ImageUtils"),r=e.model,s=i.getClosestSelectedImageElement(r.document.selection);r.change((e=>{e.setAttribute("alt",t.newValue,s)}))}}class u extends t.Plugin{static get requires(){return["ImageUtils"]}static get pluginName(){return"DrupalImageAlternativeTextEditing"}constructor(t){super(t),this._missingAltTextViewReferences=new Set}init(){const t=this.editor;t.conversion.for("editingDowncast").add(this._imageEditingDowncastConverter("attribute:alt",t)).add(this._imageEditingDowncastConverter("attribute:src",t)),t.commands.add("imageTextAlternative",new l(this.editor)),t.editing.view.on("render",(()=>{for(const t of this._missingAltTextViewReferences)t.button.element.isConnected||(t.destroy(),this._missingAltTextViewReferences.delete(t))}))}_imageEditingDowncastConverter(t){const e=(t,e,i)=>{const r=this.editor;if(!r.plugins.get("ImageUtils").isImage(e.item))return;const s=i.mapper.toViewElement(e.item),n=Array.from(s.getChildren()).find((t=>t.getCustomProperty("drupalImageMissingAltWarning")));if(e.item.hasAttribute("alt"))return void(n&&i.writer.remove(n));if(n)return;const o=r.ui.componentFactory.create("drupalImageAlternativeTextMissing");o.listenTo(r.ui,"update",(()=>{const t=r.model.document.selection.getFirstRange(),i=r.model.createRangeOn(e.item);o.set({isSelected:t.containsRange(i)||t.isIntersecting(i)})})),o.render(),this._missingAltTextViewReferences.add(o);const a=i.writer.createUIElement("span",{class:"image-alternative-text-missing-wrapper"},(function(t){const e=this.toDomElement(t);return e.appendChild(o.element),e}));i.writer.setCustomProperty("drupalImageMissingAltWarning",!0,a),i.writer.insert(i.writer.createPositionAt(s,"end"),a)};return i=>{i.on(t,e,{priority:"low"})}}}var c=i("ckeditor5/src/ui.js");function d(t){const e=t.plugins.get("ContextualBalloon");if(t.plugins.get("ImageUtils").getClosestSelectedImageWidget(t.editing.view.document.selection)){const i=m(t);e.updatePosition(i)}}function m(t){const e=t.editing.view,i=c.BalloonPanelView.defaultPositions,r=t.plugins.get("ImageUtils");return{target:e.domConverter.viewToDom(r.getClosestSelectedImageWidget(e.document.selection)),positions:[i.northArrowSouth,i.northArrowSouthWest,i.northArrowSouthEast,i.southArrowNorth,i.southArrowNorthWest,i.southArrowNorthEast,i.viewportStickyNorth]}}var g=i("ckeditor5/src/utils.js");class h extends c.View{constructor(e){super(e),this.focusTracker=new g.FocusTracker,this.keystrokes=new g.KeystrokeHandler,this.decorativeToggle=this._decorativeToggleView(),this.labeledInput=this._createLabeledInputView(),this.saveButtonView=this._createButton(Drupal.t("Save"),t.icons.check,"ck-button-save"),this.saveButtonView.type="submit",this.saveButtonView.bind("isEnabled").to(this.decorativeToggle,"isOn",this.labeledInput,"isEmpty",((t,e)=>t||!e)),this.cancelButtonView=this._createButton(Drupal.t("Cancel"),t.icons.cancel,"ck-button-cancel","cancel"),this._focusables=new c.ViewCollection,this._focusCycler=new c.FocusCycler({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"form",attributes:{class:["ck","ck-text-alternative-form","ck-text-alternative-form--with-decorative-toggle","ck-responsive-form"],tabindex:"-1"},children:[{tag:"div",attributes:{class:["ck","ck-text-alternative-form__decorative-toggle"]},children:[this.decorativeToggle]},this.labeledInput,this.saveButtonView,this.cancelButtonView]}),(0,c.injectCssTransitionDisabler)(this)}render(){super.render(),this.keystrokes.listenTo(this.element),(0,c.submitHandler)({view:this}),[this.decorativeToggle,this.labeledInput,this.saveButtonView,this.cancelButtonView].forEach((t=>{this._focusables.add(t),this.focusTracker.add(t.element)}))}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy()}_createButton(t,e,i,r){const s=new c.ButtonView(this.locale);return s.set({label:t,icon:e,tooltip:!0}),s.extendTemplate({attributes:{class:i}}),r&&s.delegate("execute").to(this,r),s}_createLabeledInputView(){const t=new c.LabeledFieldView(this.locale,c.createLabeledInputText);return t.bind("class").to(this.decorativeToggle,"isOn",(t=>t?"ck-hidden":"")),t.label=Drupal.t("Text alternative"),t}_decorativeToggleView(){const t=new c.SwitchButtonView(this.locale);return t.set({withText:!0,label:Drupal.t("Decorative image")}),t.on("execute",(()=>{t.set("isOn",!t.isOn)})),t}}class p extends c.View{constructor(t){super(t);const e=this.bindTemplate;this.set("isVisible"),this.set("isSelected");const i=Drupal.t("Add missing alternative text");this.button=new c.ButtonView(t),this.button.set({label:i,tooltip:!1,withText:!0}),this.setTemplate({tag:"span",attributes:{class:["image-alternative-text-missing",e.to("isVisible",(t=>t?"":"ck-hidden"))],title:i},children:[this.button]})}}class f extends t.Plugin{static get requires(){return[c.ContextualBalloon]}static get pluginName(){return"DrupalImageTextAlternativeUI"}init(){if(this._createButton(),this._createForm(),this._createMissingAltTextComponent(),this.editor.plugins.has("ImageUploadEditing")){const t=this.editor.plugins.get("ImageUploadEditing"),e=this.editor.plugins.get("ImageUtils");t.on("uploadComplete",(()=>{e.getClosestSelectedImageWidget(this.editor.editing.view.document.selection)&&this._showForm()}))}}_createMissingAltTextComponent(){this.editor.ui.componentFactory.add("drupalImageAlternativeTextMissing",(t=>{const e=new p(t);return e.listenTo(e.button,"execute",(()=>{this._isInBalloon&&this._balloon.remove(this._form),this._showForm()})),e.listenTo(this.editor.ui,"update",(()=>{e.set({isVisible:!this._isVisible||!e.isSelected})})),e}))}destroy(){super.destroy(),this._form.destroy()}_createButton(){const e=this.editor;e.ui.componentFactory.add("drupalImageAlternativeText",(i=>{const r=e.commands.get("imageTextAlternative"),s=new c.ButtonView(i);return s.set({label:Drupal.t("Change image alternative text"),icon:t.icons.lowVision,tooltip:!0}),s.bind("isEnabled").to(r,"isEnabled"),this.listenTo(s,"execute",(()=>{this._showForm()})),s}))}_createForm(){const t=this.editor,e=t.editing.view.document,i=t.plugins.get("ImageUtils");this._balloon=this.editor.plugins.get("ContextualBalloon"),this._form=new h(t.locale),this._form.render(),this.listenTo(this._form,"submit",(()=>{t.execute("imageTextAlternative",{newValue:this._form.decorativeToggle.isOn?"":this._form.labeledInput.fieldView.element.value}),this._hideForm(!0)})),this.listenTo(this._form,"cancel",(()=>{this._hideForm(!0)})),this.listenTo(this._form.decorativeToggle,"execute",(()=>{d(t)})),this._form.keystrokes.set("Esc",((t,e)=>{this._hideForm(!0),e()})),this.listenTo(t.ui,"update",(()=>{i.getClosestSelectedImageWidget(e.selection)?this._isVisible&&d(t):this._hideForm(!0)})),(0,c.clickOutsideHandler)({emitter:this._form,activator:()=>this._isVisible,contextElements:[this._balloon.view.element],callback:()=>this._hideForm()})}_showForm(){if(this._isVisible)return;const t=this.editor,e=t.commands.get("imageTextAlternative"),i=this._form.decorativeToggle,r=this._form.labeledInput;this._form.disableCssTransitions(),this._isInBalloon||this._balloon.add({view:this._form,position:m(t)}),i.isOn=""===e.value,r.fieldView.element.value=e.value||"",r.fieldView.value=r.fieldView.element.value,i.isOn?i.focus():r.fieldView.select(),this._form.enableCssTransitions()}_hideForm(t){this._isInBalloon&&(this._form.focusTracker.isFocused&&this._form.saveButtonView.focus(),this._balloon.remove(this._form),t&&this.editor.editing.view.focus())}get _isVisible(){return this._balloon.visibleView===this._form}get _isInBalloon(){return this._balloon.hasView(this._form)}}class b extends t.Plugin{static get requires(){return[u,f]}static get pluginName(){return"DrupalImageAlternativeText"}}class w extends t.Plugin{static get requires(){return[a,b]}static get pluginName(){return"DrupalImage"}}var v=w;class y extends t.Plugin{init(){const{editor:t}=this;t.plugins.get("ImageUploadEditing").on("uploadComplete",((e,{data:i,imageElement:r})=>{t.model.change((t=>{t.setAttribute("dataEntityUuid",i.response.uuid,r),t.setAttribute("dataEntityType",i.response.entity_type,r)}))}))}static get pluginName(){return"DrupalImageUploadEditing"}}var x=i("ckeditor5/src/upload.js");class _{constructor(t,e){this.loader=t,this.options=e}upload(){return this.loader.file.then((t=>new Promise(((e,i)=>{this._initRequest(),this._initListeners(e,i,t),this._sendRequest(t)}))))}abort(){this.xhr&&this.xhr.abort()}_initRequest(){this.xhr=new XMLHttpRequest,this.xhr.open("POST",this.options.uploadUrl,!0),this.xhr.responseType="json"}_initListeners(t,e,i){const r=this.xhr,s=this.loader,n=`Couldn't upload file: ${i.name}.`;r.addEventListener("error",(()=>e(n))),r.addEventListener("abort",(()=>e())),r.addEventListener("load",(()=>{const i=r.response;if(!i||i.error)return e(i&&i.error&&i.error.message?i.error.message:n);t({response:i,urls:{default:i.url}})})),r.upload&&r.upload.addEventListener("progress",(t=>{t.lengthComputable&&(s.uploadTotal=t.total,s.uploaded=t.loaded)}))}_sendRequest(t){const e=this.options.headers||{},i=this.options.withCredentials||!1;Object.keys(e).forEach((t=>{this.xhr.setRequestHeader(t,e[t])})),this.xhr.withCredentials=i;const r=new FormData;r.append("upload",t),this.xhr.send(r)}}class A extends t.Plugin{static get requires(){return[x.FileRepository]}static get pluginName(){return"DrupalFileRepository"}init(){const t=this.editor.config.get("drupalImageUpload");t&&(t.uploadUrl?this.editor.plugins.get(x.FileRepository).createUploadAdapter=e=>new _(e,t):(0,g.logWarning)("simple-upload-adapter-missing-uploadurl"))}}class V extends t.Plugin{static get requires(){return[A,y]}static get pluginName(){return"DrupalImageUpload"}}var E={DrupalImage:v,DrupalImageUpload:V}}(),r=r.default}()}));